!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Amara=t()}(this,function(){function e(e,t){this[t]=e(this.target)}function t(e,t){var r=e.info.lastArgs,n=e.feature.args[t],a=n(e.args);return e.changed=e.changed||!(t in r)||a!==r[t],r[t]=a,e}function r(r){function n(e,t){var r=i.get(t);r&&r.add(e)||i.set(t,new Set([e]))}function a(e,t){return e.result[t]={get:function(){return n(e.feature,t),e.obj[t]}},e}function o(e,t){var r={obj:t,feature:e,result:{}};return Object.create(null,Object.keys(t).reduce(a,r).result)}function u(r){var n={target:r},a=this,u=f.get(a)||new WeakMap,i=u.get(r)||{logged:!1,value:void 0,lastArgs:{}};c.forEach(e,n),n=i.logged?n:o(a,n);var s={info:i,feature:a,args:n,changed:!1};if(Object.keys(a.args).reduce(t,s),!u.has(r)||s.changed){var g=Object.assign({},i.lastArgs);i.value=a.apply(g),i.logged=!0,s.changed=!0}return u.set(r,i),f.set(a,u),{changed:s.changed,value:i.value}}var i=r.keyFeatures,c=r.argProviders,s=r.featureConnections,f=new Map;return function(e){var t=u.bind(e);t.clearCache=function(t){var r=f.get(e);r&&t.forEach(r.delete,r)},s.set(e,t)}}function n(e){b.then(e)}function a(e){for(var t=[],r=arguments.length-1;r-- >0;)t[r]=arguments[r+1];try{return e.apply(void 0,t)}catch(e){return e}}function o(e){throw new Error(e)}function u(e,t,r){return void 0===t&&(t={}),void 0===r&&(r={}),{type:e,payload:t,meta:r}}function i(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return function(t){for(var r,n=e.length;r=e[--n];)r(t)}}function c(e,t){void 0===t&&(t=n);var r=!1;return function(){for(var n=[],a=arguments.length;a--;)n[a]=arguments[a];r||(r=!0,t(function(){r=!1,e.apply(void 0,n)}))}}function s(e){this.set(e,new Set)}function f(e){this.result=this.result&&e(this.arg)}function g(e,t){var r={result:!0,arg:t};return e.forEach(f,r),r.result}function p(e){return!!e&&"string"==typeof e&&e.trim().length>0}function d(e){e&&"type"in e&&"targets"in e&&"apply"in e?"function"!=typeof e.apply?o('Member "apply" must be a function.'):p(e.type)?Array.isArray(e.targets)&&e.targets.length&&e.targets.every(p)||o('Member "targets" must be a non-empty array of non-empty strings.'):o('Member "type" must be a non-empty string.'):o('Features require "type", "targets", and "apply" members.')}function h(e,t){p(e)&&"function"==typeof t||o("Method `config` expects a non-empty string and a function.")}function l(e){this.result.set(e,this.map.get(e))}function v(e){0===this.result&&(this.result=e(this.a,this.b))}function y(e){var t=this.map.get(e),r=this.invoke(e);t?t[t.length]=r:this.map.set(e,[r])}function m(e){function t(e){for(var r,n,o=L.length;n=L[--o];)if((r=a(n,e))instanceof Error){t(u("error",r));break}}function n(e){return e(t)}function f(e,t){return K.set(e,t),function(){return K.delete(e)}}function p(e){e.id=w++,e.args=e.args||{}}function m(e,t){e&&e.size&&O(t,e)}function b(e){var t=Q.get(e);t&&t.forEach(s,this)}function E(e){K.has(e)||o("No value provider has been specified for '"+e+"'."),D.add(e),X()}function k(e){e.forEach(V)}function M(e){for(var t,r=0;t=e[r++];)O(t.feature,t.targets)}function j(e){var t=e.feature,r=e.targets,n=R.get(t);n&&n.clearCache(r)}function A(e){var t=e.payload;switch(e.type){case"core:change-occurred":E(t);break;case"core:features-added":k(t);break;case"core:enqueue-apply":M(t);break;case"core:clear-cache":j(t)}}function S(e){var t=I.get("filter");return!t||g(t,e)}function O(e,t){if(S(e)){var r=J.get(e);r?t.forEach(r.add,r):J.set(e,new Set(t)),Y()}}function C(e,t){var r=R.get(t),n=this[t.type]=this[t.type]||new Map;e.forEach(y,{map:n,invoke:r,type:t.type})}function x(e,t){var r={result:0,a:e,b:t},n=I.get("sorter");return n?(n.forEach(v,r),r.result):0}function F(e,t){return e.id-t.id}function P(e){var t=Array.from(e.keys()),r={map:e,result:new Map};return t.sort(F),t.sort(x),t.forEach(l,r),r.result}function q(e){return e.changed}function z(e){return e.value}function N(e,t){if(!e.some(q))return this.delete(t);this.set(t,e.map(z))}function T(e){var t=this[e];t.forEach(N,t),t.size||delete this[e]}function W(e){Object.keys(e).forEach(T,e)}void 0===e&&(e=[]);var B=!1,D=new Set,G=new Set,H=[],I=new Map,J=new Map,K=new Map,L=[A].concat(e.map(n)),Q=new Map,R=new Map,U=r({featureConnections:R,argProviders:K,keyFeatures:Q}),V=i(Array.prototype.push.bind(H),U),X=c(function(){var e=new Map;D.forEach(b,e),t(u("core:populate-feature-targets",e)),P(e).forEach(m),D.clear()},setTimeout),Y=c(function(){var e={};P(J).forEach(C,e),W(e),J.clear(),Object.keys(e).length&&t(u("core:apply-target-results",e))}),Z=c(function(e){t(u("core:bootstrap",e))}),$=c(function(){var e=new Set(G);G.clear(),t(u("core:features-added",e))}),_={bootstrap:function(e){return B&&o("Amara already bootstrapped."),B=!0,Z({target:e,register:f}),_},add:function(e){return H.includes(e)||(d(e),p(e),G.add(e),$()),_},config:function(e,t){h(e,t);var r=I.get(e);return r&&r.add(t)||I.set(e,new Set([t])),_}};return _}var b=Promise.resolve(),w=0;return m});
//# sourceMappingURL=amara-core.umd.min.js.map